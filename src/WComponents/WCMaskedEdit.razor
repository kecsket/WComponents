@inherits InputText
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime

<input @ref=InputElementReference
       @attributes="AdditionalAttributes"
       class="@CssClass"
       value="@CurrentValue"
       @oninput="EventCallback.Factory.CreateBinder<string>(this, __value => CurrentValueAsString = __value, CurrentValueAsString)"
       @onkeypress="KeyPressed"
       @onkeydown="KeyDown"/>

@code
{
    private Task<IJSObjectReference> _module;
    private Task<IJSObjectReference> Module => _module ??= JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/WComponents/js/WCMaskedEdit.js").AsTask();

    ElementReference InputElementReference;
    private int KeyDownPosition = 99999;

    private async void KeyDown(KeyboardEventArgs args)
    {
        KeyDownPosition = await GetCaretPositionAsync();
    }

    private void KeyPressed(KeyboardEventArgs args)
    {
        if (args.Key == "r")
        {
            CurrentValueAsString = "httthhhhhr" + KeyDownPosition.ToString();

        }
        if (args.Key == "t")
        {
            SetCaretPosition(2);
        }
    }

    private void SetCaretPosition(int position)
    {
        Task.Run(async () => await SetCaretPositionAsync(position));
    }

    private async Task SetCaretPositionAsync(int position)
    {
        var module = await Module;
        await module.InvokeVoidAsync("setCaretPosition", InputElementReference, position);
    }

    private async Task<int> GetCaretPositionAsync()
    {
        var module = await Module;
        return await module.InvokeAsync<int>("getCaretPosition", InputElementReference);
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            var module = await _module;
            await module.DisposeAsync();
        }
    }
}